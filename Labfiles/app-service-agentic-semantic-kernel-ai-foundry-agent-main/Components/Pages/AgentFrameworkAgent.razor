@page "/agentfx"
@using Microsoft.Extensions.AI
@using Microsoft.Agents.AI
@using Microsoft.AspNetCore.Components
@inject CRUDTasksWithAgent.Services.IAgentFrameworkProvider AgentProvider
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

@if (AgentProvider.Agent == null)
{
    <div class="alert alert-warning" role="alert">
        The Agent Framework agent is not configured. Please set the required environment 
        variables (<code>ModelDeployment</code> and <code>AzureOpenAIEndpoint</code>) 
        in your appsettings or environment to enable this feature.
    </div>
}
else
{
    <div class="container-fluid d-flex flex-column align-items-center justify-content-center" style="height: 100vh;">
        <div class="card shadow w-100" style="max-width: 600px; height: 80vh; min-height: 400px; display: flex; flex-direction: column;">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">Microsoft Agent Framework</h3>
            </div>
            <div class="card-body flex-grow-1 overflow-auto" id="chatMessages" style="min-height: 0;">
                @{
                    ChatRole? lastRole = null;
                }
                @foreach (var message in this.agentThread?.GetService<IList<ChatMessage>>() ?? Enumerable.Empty<ChatMessage>())
                {
                    if (string.IsNullOrWhiteSpace(message.Text))
                    {
                        continue;
                    }
                    bool showAvatar = lastRole != message.Role;
                    if (showAvatar)
                    {
                        <div class="my-2 fw-bold d-flex @(message.Role == ChatRole.User ? "justify-content-end" : "justify-content-start")">
                            @(message.Role == ChatRole.User ? "User" : "Agent")
                        </div>
                    }
                    <div class="mb-2 p-2 rounded @((message.Role == ChatRole.User) ? "bg-primary text-white ms-auto" : "bg-success bg-opacity-10 text-dark me-auto")" style="max-width: 80%; word-break: break-word;">
                        @if (message.Role == ChatRole.User)
                        {
                            @message.Text
                        }
                        else
                        {
                            @((MarkupString)message.Text.Replace("\n", "<br />"))
                        }
                    </div>
                    lastRole = message.Role;
                }
            </div>
            <div class="card-footer bg-light">
                <EditForm Model="this" OnValidSubmit="@(() => SendMessageAsync())" FormName="chatForm">
                    <div class="input-group">
                        <InputText @bind-Value="userInput" @onkeypress="@(e => HandleKeyPress(e))" class="form-control" placeholder="Type your message..." />
                        <button type="submit" class="btn btn-primary">Send</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    private string? userInput;
    private AIAgent? Agent => AgentProvider.Agent;
    // Use the thread created by the provider (scoped to browser session)
    private AgentThread? agentThread => AgentProvider.Thread;

    // Given the injected Agent Framework agent and the thread, simply call Agent.RunAsync()
    // to process the user prompt.

    private async Task SendMessageAsync()
    {
        if (!string.IsNullOrWhiteSpace(this.userInput) && this.Agent != null)
        {
            var sentInput = this.userInput;
            this.userInput = string.Empty;
            StateHasChanged();

            // Send message to agent and get response using Agent Framework pattern
            var response = await this.Agent.RunAsync(sentInput, this.agentThread);
            
            StateHasChanged();
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(this.userInput))
        {
            await SendMessageAsync();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JSRuntime.InvokeVoidAsync("eval", @"
            var element = document.getElementById('chatMessages');
            if (element) {
                element.scrollTop = element.scrollHeight;
            }
        ");
    }
}
